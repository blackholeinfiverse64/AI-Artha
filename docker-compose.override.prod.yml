# Production overrides for docker-compose.prod.yml
# This file allows customization without modifying the main production file

version: '3.8'

services:
  backend:
    # Override with custom image if needed
    # image: your-registry/artha-backend:latest
    
    # Additional environment variables
    environment:
      - LOG_LEVEL=info
      - RATE_LIMIT_MAX=200
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Additional volumes for custom configurations
    volumes:
      - ./config/custom.json:/app/config/custom.json:ro
    
    # Restart policy
    restart: unless-stopped

  frontend:
    # Override with custom image if needed
    # image: your-registry/artha-frontend:latest
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Custom nginx configuration
    volumes:
      - ./nginx/custom.conf:/etc/nginx/conf.d/custom.conf:ro
    
    restart: unless-stopped

  mongodb:
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # Custom MongoDB configuration
    volumes:
      - ./mongo/mongod.conf:/etc/mongod.conf:ro
    
    restart: unless-stopped

  redis:
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    restart: unless-stopped

  # Optional: Add backup service
  backup:
    image: alpine:latest
    container_name: artha-backup
    volumes:
      - ./scripts:/scripts:ro
      - ./backups:/app/backups
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_S3_BUCKET=${BACKUP_S3_BUCKET}
    command: |
      sh -c "
        apk add --no-cache docker-cli aws-cli &&
        echo '0 2 * * *' /scripts/backup-prod.sh | crontab - &&
        crond -f
      "
    networks:
      - artha-network
    restart: unless-stopped

  # Optional: Add monitoring service
  monitoring:
    image: prom/node-exporter:latest
    container_name: artha-monitoring
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - artha-network
    restart: unless-stopped