apiVersion: artha/v1
kind: Deployment
metadata:
  name: artha-prod
  labels:
    app: artha
    version: v0.1.0
    environment: production
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  services:
    # MongoDB Service
    - name: mongodb
      image: mongo:7
      replicas: 1
      ports:
        - name: mongo
          port: 27017
          protocol: TCP
      environment:
        MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
        MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
        MONGO_INITDB_DATABASE: artha_prod
      volumes:
        - name: mongo-data
          mountPath: /data/db
          size: 20Gi
        - name: mongo-config
          mountPath: /data/configdb
          size: 1Gi
      healthCheck:
        type: exec
        command: 
          - mongosh
          - --eval
          - "db.adminCommand('ping')"
        initialDelaySeconds: 30
        periodSeconds: 30
        timeoutSeconds: 10
        successThreshold: 1
        failureThreshold: 3
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2
          memory: 4Gi
      
    # Redis Service
    - name: redis
      image: redis:7-alpine
      replicas: 1
      ports:
        - name: redis
          port: 6379
          protocol: TCP
      command:
        - redis-server
        - --requirepass
        - ${REDIS_PASSWORD}
        - --maxmemory
        - 512mb
        - --maxmemory-policy
        - allkeys-lru
      volumes:
        - name: redis-data
          mountPath: /data
          size: 5Gi
      healthCheck:
        type: exec
        command:
          - redis-cli
          - -a
          - ${REDIS_PASSWORD}
          - ping
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      resources:
        requests:
          cpu: 250m
          memory: 256Mi
        limits:
          cpu: 1
          memory: 512Mi
      
    # Backend Service
    - name: backend
      image: artha-backend:${VERSION}
      replicas: 2
      ports:
        - name: http
          port: 5000
          protocol: TCP
      environment:
        NODE_ENV: production
        PORT: "5000"
        API_VERSION: v1
        MONGODB_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/artha_prod?authSource=admin
        JWT_SECRET: ${JWT_SECRET}
        JWT_EXPIRE: 24h
        JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
        HMAC_SECRET: ${HMAC_SECRET}
        REDIS_HOST: redis
        REDIS_PORT: "6379"
        REDIS_PASSWORD: ${REDIS_PASSWORD}
        FRONTEND_URL: https://${DOMAIN}
        RATE_LIMIT_WINDOW_MS: "900000"
        RATE_LIMIT_MAX: "100"
        LOG_LEVEL: info
        ADMIN_EMAIL: ${ADMIN_EMAIL}
        ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      volumes:
        - name: uploads
          mountPath: /app/uploads
          size: 10Gi
        - name: logs
          mountPath: /app/logs
          size: 5Gi
      healthCheck:
        type: http
        path: /health
        port: 5000
        scheme: HTTP
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      readinessProbe:
        type: http
        path: /ready
        port: 5000
        scheme: HTTP
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 3
        successThreshold: 1
        failureThreshold: 3
      livenessProbe:
        type: http
        path: /live
        port: 5000
        scheme: HTTP
        initialDelaySeconds: 60
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 2
          memory: 2Gi
      
    # Frontend Service
    - name: frontend
      image: artha-frontend:${VERSION}
      replicas: 2
      ports:
        - name: http
          port: 80
          protocol: TCP
        - name: https
          port: 443
          protocol: TCP
      environment:
        VITE_API_URL: https://api.${DOMAIN}/api/v1
        VITE_ENV: production
      healthCheck:
        type: http
        path: /health
        port: 80
        scheme: HTTP
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      resources:
        requests:
          cpu: 250m
          memory: 256Mi
        limits:
          cpu: 1
          memory: 512Mi

  # Ingress Configuration
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
    rules:
      - host: ${DOMAIN}
        http:
          paths:
            - path: /
              pathType: Prefix
              backend:
                service: frontend
                port: 80
      - host: api.${DOMAIN}
        http:
          paths:
            - path: /
              pathType: Prefix
              backend:
                service: backend
                port: 5000
    tls:
      - secretName: artha-tls-cert
        hosts:
          - ${DOMAIN}
          - api.${DOMAIN}

  # Backup Configuration
  backup:
    enabled: true
    schedule: "0 2 * * *"  # Daily at 2 AM
    retention: 30  # Keep 30 days of backups
    targets:
      - service: mongodb
        type: mongodump
        destination: s3://artha-backups/mongodb/
      - service: backend
        type: volume
        volumes:
          - uploads
        destination: s3://artha-backups/uploads/

  # Monitoring Configuration
  monitoring:
    enabled: true
    prometheus:
      enabled: true
      scrapeInterval: 30s
      endpoints:
        - service: backend
          port: 5000
          path: /metrics
    alerts:
      - name: HighErrorRate
        condition: error_rate > 5%
        duration: 5m
        severity: critical
      - name: HighMemoryUsage
        condition: memory_usage > 80%
        duration: 10m
        severity: warning
      - name: ServiceDown
        condition: health_check_failed
        duration: 2m
        severity: critical

  # Auto-scaling Configuration
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    scaleDownStabilizationWindowSeconds: 300

  # Network Policies
  networkPolicy:
    enabled: true
    ingress:
      - from:
          - service: frontend
        to:
          - service: backend
      - from:
          - service: backend
        to:
          - service: mongodb
          - service: redis
    egress:
      - from:
          - service: backend
        to:
          - external: true
            ports:
              - 443  # HTTPS for external APIs

  # Security Context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
    capabilities:
      drop:
        - ALL

  # Init Containers
  initContainers:
    - name: wait-for-mongodb
      image: busybox:1.35
      command:
        - sh
        - -c
        - |
          until nc -z mongodb 27017; do
            echo "Waiting for MongoDB..."
            sleep 2
          done
    - name: create-indexes
      image: artha-backend:${VERSION}
      command:
        - npm
        - run
        - create-indexes
      environment:
        MONGODB_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/artha_prod?authSource=admin

  # Post-deployment Jobs
  postDeploy:
    - name: seed-database
      image: artha-backend:${VERSION}
      command:
        - npm
        - run
        - seed
      runOnce: true
      condition: firstDeploy
